<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Warp Starfield</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #FFF8E7;  /* cosmic latte! */
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .hint { color: #555; font-size: 0.9rem; margin-top: 8px;}
    canvas {
      display: block;
      background: black;
    }
  </style>
</head>
<body>
  <canvas id="space"></canvas>
  <div class="hint">
    W/S: accelerate / decelerate<br>
    ↑/↓/←/→: move
  </div>
  <script>
    const CANVAS_SIZE_RATE = 0.8;
    const canvas = document.getElementById("space");
    const ctx = canvas.getContext("2d");
    let centralPoint = { x: 0, y: 0 };
    let vanishingPoint = { x: 0, y: 0 };
    let vanishingPointDiff = { x: 0, y: 0 };

    let speed = 5;
    const SpeedMax = 20;
    const SpeedMin = 1;
    const accelRate = 0.05;

    const keys = {
      w: false,
      s: false,
      ArrowUp: false,
      ArrowDown: false,
      ArrowLeft: false,
      ArrowRight: false,
    };


    let Stars = [];
    const SpawnRate = 20; // milliseconds

    let lastTime = 0;
    let spawnTimer = 0;

    function generateRandomStar() {
      return {
        angle: Math.random() * 2 * Math.PI,
        radius: Math.random(),
        speed: speed,
        vanishingPoint: { x: vanishingPoint.x, y: vanishingPoint.y },
      };
    }

    function spawnStar(){
        Stars.push(generateRandomStar());
    }

    function removeStar(index) {
        Stars.splice(index, 1);
    }

    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;

      canvas.width  = Math.floor(w * CANVAS_SIZE_RATE);
      canvas.height = Math.floor(h * CANVAS_SIZE_RATE);
      
      centralPoint.x = Math.floor(canvas.width / 2);
      centralPoint.y = Math.floor(canvas.height / 2);
      vanishingPoint.x = centralPoint.x;
      vanishingPoint.y = centralPoint.y;

      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function starInCanvas(star) {
        const x = vanishingPoint.x + star.radius * Math.cos(star.angle);
        const y = vanishingPoint.y + star.radius * Math.sin(star.angle);
        return 0 <= x && x <= canvas.width && 0 <= y && y <= canvas.height;
    }

    function updateStars(dt) {
        for (let i = Stars.length - 1; i >= 0; i--) {
            const star = Stars[i];
            let diff = star.speed * (dt / 1000) * star.radius
            star.radius += diff;

            if (!starInCanvas(star)) {
                removeStar(i);
            }
        }
    }

    function starSize(star) {
        return Math.min(star.radius * 0.02, 4);
    }

    function renderStars() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "white";
        Stars.forEach(star => {
            const x = star.vanishingPoint.x + star.radius * Math.cos(star.angle);
            const y = star.vanishingPoint.y + star.radius * Math.sin(star.angle);
            
            const size = starSize(star);
            
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function loop(time) {
        const dt = time - lastTime;
        lastTime = time;

        spawnTimer += dt;

        if (keys.w || keys.s){
          if (keys.w) {
            speed += accelRate;
          }
          if (keys.s) {
            speed -= accelRate;
          }
          speed = Math.min(Math.max(speed, SpeedMin), SpeedMax);
          Stars.forEach(star => {
            star.speed = speed;
          });
        }
        const rotateSpeed = 1;
        if (keys.ArrowUp || keys.ArrowDown || keys.ArrowLeft || keys.ArrowRight) {
          if (keys.ArrowUp) {
            vanishingPoint.y -= rotateSpeed;
          }
          if (keys.ArrowDown) {
            vanishingPoint.y += rotateSpeed;
          }
          if (keys.ArrowLeft) {
            vanishingPoint.x -= rotateSpeed;
          }
          if (keys.ArrowRight) {
            vanishingPoint.x += rotateSpeed;
          }
          if (vanishingPoint.x < 0) vanishingPoint.x = 0;
          if (vanishingPoint.x > canvas.width) vanishingPoint.x = canvas.width;
          if (vanishingPoint.y < 0) vanishingPoint.y = 0;
          if (vanishingPoint.y > canvas.height) vanishingPoint.y = canvas.height;
        }
        const returnSpeed = 0.5;
        if (!keys.ArrowUp && !keys.ArrowDown) {
          if (centralPoint.y < vanishingPoint.y){
            if (vanishingPoint.y - centralPoint.y < returnSpeed * 3){
              vanishingPoint.y = centralPoint.y;
            }
            else{
              vanishingPoint.y -= returnSpeed;
            }
          }
          else{
            if (centralPoint.y - vanishingPoint.y < returnSpeed * 3){
              vanishingPoint.y = centralPoint.y;
            }
            else{
              vanishingPoint.y += returnSpeed;
            }
          } 
        }
        if (!keys.ArrowLeft && !keys.ArrowRight) {
          if (centralPoint.x < vanishingPoint.x){
            if (vanishingPoint.x - centralPoint.x < returnSpeed * 3){
              vanishingPoint.x = centralPoint.x;
            }
            else{
              vanishingPoint.x -= returnSpeed;
            }
          }
          else{
            if (centralPoint.x - vanishingPoint.x < returnSpeed * 3){
              vanishingPoint.x = centralPoint.x;
            }
            else{
              vanishingPoint.x += returnSpeed;
            }
          }
        }

        if (spawnTimer > SpawnRate) {
            for (i=1; i<=10; i++){
              spawnStar();
            }
            spawnTimer = 0;
        }

        updateStars(dt);
        renderStars();

        requestAnimationFrame(loop);
    }

    // Initialize canvas size
    resizeCanvas();
    requestAnimationFrame(loop);

    window.addEventListener("resize", resizeCanvas);

    window.addEventListener("keydown", (e) => {
      if (e.key in keys) {
        keys[e.key] = true;
        e.preventDefault(); // 矢印キーのスクロール防止
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key in keys) {
        keys[e.key] = false;
        e.preventDefault();
      }
    });
  </script>

</body>
</html>
